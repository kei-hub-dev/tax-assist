<% account_options = current_user.accounts.order(:category, :name) %>

<div class="table-wrap mt-12">
  <table class="table">
    <thead>
      <tr>
        <th>勘定科目</th>
        <th>貸借</th>
        <th class="text-right">金額</th>
        <th>メモ</th>
        <th class="col-100"></th>
      </tr>
    </thead>
    <tbody id="lines">
      <%= f.fields_for :journal_entry_lines do |lf| %>
        <tr class="line">
          <%= lf.hidden_field :id %>
          <%= lf.hidden_field :_destroy, value: 0 %>
          <td><%= lf.collection_select :account_id, account_options, :id, :name, include_blank: "選択" %></td>
          <td><%= lf.select :dc, [["借方","debit"],["貸方","credit"]], include_blank: "選択" %></td>
          <td class="text-right"><%= lf.number_field :amount, min: 0, step: 1 %></td>
          <td><%= lf.text_field :memo %></td>
          <td>
            <button type="button" class="btn btn-outline btn-sm" onclick="this.closest('tr').querySelector('input[name*=\'[_destroy]\']').value=1; this.closest('tr').style.display='none';">
              行削除
            </button>
          </td>
        </tr>
        <tr class="line-errors">
          <td colspan="5">
            <%= render "shared/error_messages", object: lf.object %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <div class="actions mt-8">
    <button type="button" class="btn btn-sm" id="add-line-btn">行を追加</button>
  </div>
</div>

<% prototype_html = capture do %>
  <%= f.fields_for :journal_entry_lines, JournalEntryLine.new, child_index: "NEW_RECORD" do |lf| %>
    <tr class="line">
      <%= lf.hidden_field :id %>
      <%= lf.hidden_field :_destroy, value: 0 %>
      <td><%= lf.collection_select :account_id, account_options, :id, :name, include_blank: "選択" %></td>
      <td><%= lf.select :dc, [["借方","debit"],["貸方","credit"]], include_blank: "選択" %></td>
      <td class="text-right"><%= lf.number_field :amount, min: 0, step: 1, value: 0 %></td>
      <td><%= lf.text_field :memo %></td>
      <td>
        <button type="button" class="btn btn-outline btn-sm" onclick="this.closest('tr').querySelector('input[name*=\'[_destroy]\']').value=1; this.closest('tr').style.display='none';">
          行削除
        </button>
      </td>
    </tr>
    <tr class="line-errors">
      <td colspan="5">
        <%= render "shared/error_messages", object: lf.object %>
      </td>
    </tr>
  <% end %>
<% end %>

<script>
  (function() {
    var addBtn = document.getElementById('add-line-btn');
    if (!addBtn) return;
    var tbody = document.getElementById('lines');
    var template = `<%= j prototype_html %>`;
    addBtn.addEventListener('click', function() {
      var unique = Date.now().toString();
      var html = template.replace(/NEW_RECORD/g, unique);
      var temp = document.createElement('tbody');
      temp.innerHTML = html.trim();
      var row = temp.firstElementChild;
      tbody.appendChild(row);
      var err = row.nextElementSibling;
      if (err && err.classList.contains('line-errors')) tbody.appendChild(err);
    });
  })();
</script>
