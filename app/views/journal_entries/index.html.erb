<% content_for :title, "仕訳 新規登録/編集" %>
<div class="page">
  <div class="narrow">
    <h1 class="page-title">仕訳 新規登録/編集</h1>
    <div class="year-banner">選択中の会計年度:<span class="year-pill"><%= current_period.accounting_year %></span></div>

    <div class="menu-group mt-16">
      <h2 class="group-title">新規登録</h2>

      <%= render "shared/error_messages", object: @entry %>

      <%= form_with model: @entry, url: journal_entries_path, method: :post, local: true, html: { class: "form" } do |f| %>
        <div class="field">
          <label for="journal_entry_entry_date">日付</label>
          <%= f.date_field :entry_date %>
        </div>

        <!-- 追加：概要（description） -->
        <div class="field mt-3">
          <%= f.label :description, "概要" %>
          <%= f.text_field :description, class: "input", placeholder: "例）備品購入／振込手数料 など", list: "journal-entry-description-list" %>
        </div>
        <!-- /追加 -->

        <%= render partial: "lines_fields", locals: { f: f } %>

        <div class="actions vstack">
          <%= f.submit "保存", class: "btn btn-sm btn-block" %>
        </div>
      <% end %>

      <%= render partial: "autocomplete_datalists", locals: { description_suggestions: @description_suggestions, memo_suggestions: @memo_suggestions } %>
    </div>

    <div class="table-wrap mt-16">
      <table class="table">
        <thead>
          <tr>
            <th>伝票No</th>
            <th>日付</th>
            <th>概要</th> <!-- 追加 -->
            <th class="actions-col">操作</th>
          </tr>
        </thead>
        <tbody>
          <% if @entries.any? %>
            <% @entries.each do |entry| %>
              <tr>
                <td><%= entry.entry_no %></td>

                <td><%= entry.entry_date.strftime("%Y-%m-%d") %></td>

                <!-- 追加：概要カラム（横に表示） -->
                <td>
                  <% if entry.description.present? %>
                    <span><%= truncate(entry.description, length: 50) %></span>
                  <% else %>
                    <span class="text-muted">—</span>
                  <% end %>
                </td>

                <td class="actions-cell">
                  <div class="action-buttons"
                      style="display:flex; gap:.5rem; justify-content:flex-end; align-items:center;">
                    <%= link_to "編集",
                          edit_journal_entry_path(entry),
                          class: "btn btn-sm",
                          style: "flex:0 0 auto; width:auto; min-width:auto; padding:.375rem .75rem;" %>

                    <%= button_to "削除",
                          journal_entry_path(entry),
                          method: :delete,
                          form: { style: "display:inline;", data: { turbo_confirm: "削除しますか？" } },
                          class: "btn btn-outline btn-sm",
                          style: "flex:0 0 auto; width:auto; min-width:auto; padding:.375rem .75rem;" %>
                  </div>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="4" class="text-center text-muted">登録された仕訳はありません</td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <div class="actions mt-12">
      <%= link_to "会計メニューに戻る", accounting_menu_path, class: "btn btn-outline btn-sm btn-block" %>
    </div>
  </div>
</div>
